version: 2
jobs:
  build:
    docker:
      - image: circleci/openjdk:11.0.5-stretch
    
    working_directory: ~/ccwebapp/webapp
    
    steps:
      - checkout:
          path: ~/ccwebapp

      - run:
          name: Install packages
          command: sudo apt-get update && sudo apt-get install wget zip unzip -y
      - run:
          name: Install python3-pip
          command: |
            sudo apt install python3
            curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
            sudo python3 get-pip.py
      - run:
          name: Install awscli
          command: sudo pip install awscli

      # Download and cache dependencies
      - restore_cache:
          keys:
          - ccwebapp-{{ checksum "pom.xml" }}

      - run: mvn dependency:go-offline

      - save_cache:
          paths:
            - ~/.m2
          key: ccwebapp-{{ checksum "pom.xml" }}

      # - run:
      #     name: Run unit tests
      #     command: 

      - run:
          name: Build artifacts (package into a jar)
          command: mvn clean package  -Dmaven.test.skip=true
      
      - run:
          name: Collect artifacts
          command: |
            mkdir artifacts
            cp target/demo-0.0.1-SNAPSHOT.jar artifacts
            cp target/classes/application.properties artifacts  
      
      # store raw contents of src code
      - store_artifacts:
          path: artifacts
          destination: ccwebapp

      - run:
          name: Zip artifacts
          command: zip -j artifacts/artifacts.zip artifacts/*.*  
      - run:
          name: Upload to AWS S3
          command: aws s3 cp artifacts/application.properties s3://codedeploy.tianlifeng.me

      # - run:
      #     name: Call AWS CodeDeploy
      #     command: 

    branches:
      only:
        - assign7